{"version":3,"sources":["../../../src/routes/api/lobbys.js"],"names":["router","requireLobbys","req","res","next","lobbys","app","get","requireLobby","index","lobbyFound","filter","l","i","id","toString","params","status","json","message","lobby","lobbyIndex","err","participantEmail","post","requireJwtAuth","Lobby","create","participants","body","startTime","gameHostId","participantId","guideId","game","populate","path","model","execPopulate","toJSON","users","map","user","email","username","role","joined","connected","push","requireSocketAuth","userId","userFound","u","io","to","emit","ON_LOBBY_UPDATE","socket","leave","isGamePoweredOn","User","findById","updatedLobby","findByIdAndUpdate","new","join","isParticipant","some","newLobbyUser","forEach","splice","delete","findByIdAndRemove","put","gameId","Object","assign"],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport requireJwtAuth from '../../middleware/requireJwtAuth';\nimport requireSocketAuth from '../../middleware/requireSocketAuth';\n\nimport { v4 as uuidv4 } from 'uuid';\n\nimport User from '../../models/User';\n\nimport { ON_LOBBY_UPDATE } from '../../constants';\nimport Lobby from '../../models/Lobby';\n\nconst router = Router();\n\nfunction requireLobbys(req, res, next) {\n  req.lobbys = req.app.get('lobbys');\n  next()\n}\n\nfunction requireLobby(req, res, next) {\n  let index\n\n  const lobbys = req.app.get('lobbys');\n  req.lobbys = lobbys\n\n  const lobbyFound = lobbys.filter((l, i) => {\n    if(l.id.toString() === req.params.id) {\n      index = i\n      return true\n    } else {\n      return false\n    }\n  })[0]\n\n  if(!lobbyFound) {\n    res.status(400).json({ message: 'No lobby found with id: ' + req.params.id });\n    return \n  }\n\n  req.lobby = lobbyFound\n  req.lobbyIndex = index\n  next()\n}\n\nrouter.get('/', requireLobbys, async (req, res) => {\n  try {    \n    res.json({\n      lobbys: req.lobbys\n    });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.get('/:id', requireLobby, async (req, res) => {\n  try {\n    res.json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.get('/byEmail/:participantEmail', requireLobbys, async (req, res) => {\n  try {\n\n    const lobbyFound = req.lobbys.filter((l, i) => {\n      if(l.participantEmail === req.params.participantEmail) {\n        return true\n      } else {\n        return false\n      }\n    })[0]\n\n    if(!lobbyFound) {\n      res.status(400).json({ message: 'No lobby found for: ' + req.params.participantEmail, });\n    }\n      \n    res.json({ lobby: lobbyFound });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.post('/', requireJwtAuth, requireLobbys, async (req, res) => {\n  try {\n    let lobby = await Lobby.create({\n      participants: req.body.participants,\n      startTime: req.body.startTime,\n      gameHostId: req.body.gameHostId,\n      participantId: req.body.participantId,\n      guideId: req.body.guideId,\n      game: req.body.game\n    });\n\n    lobby = await lobby.populate('participants game').populate({\n      path: 'game',\n      populate: {\n        path: 'user',\n        model: 'User'\n      }\n    }).execPopulate();\n\n    lobby = lobby.toJSON()\n\n    lobby.users = lobby.participants.map((user) => {\n      return {\n        email: user.email,\n        id: user.id,\n        username: user.username,\n        role: user.role,\n        joined: false,\n        connected: false\n      }\n    })\n\n    req.lobbys.push(lobby)\n\n    res.status(200).json({ lobbys: req.lobbys });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.post('/leave/:id', requireJwtAuth, requireLobby, requireSocketAuth, async (req, res) => {\n  try {\n    if (!(req.body.userId === req.user.id || req.user.role === 'ADMIN')) {\n      return res.status(400).json({ message: 'You do not have privileges to remove user from that lobby.' });\n    }\n\n    // let index;\n    const userFound = req.lobby.users.filter((u, i) => {\n      if(u.id === req.body.userId) {\n        // index = i\n        return true\n      } else {\n        return false\n      }\n    })[0]\n\n    if(!userFound) {\n      return res.status(400).json({ message: 'No user with id ' + req.body.userId + ' found in lobby' });\n    }\n\n    userFound.joined = false\n\n    req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n    req.socket.leave(req.lobby.id)\n    if(req.user.role === 'ADMIN') req.socket.leave('admins@'+req.lobby.id);\n    res.status(200).json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.post('/assign/:id', requireJwtAuth, requireLobby, requireSocketAuth, async (req, res) => {\n  if (!(req.user.role === 'ADMIN' || req.user.id === req.body.userId)) {\n    return res.status(400).json({ message: 'You do not have privileges to assign that role.' });\n  }\n\n  const userFound = req.lobby.users.filter((u, i) => {\n    if(u.id === req.body.userId) {\n      return true\n    } else {\n      return false\n    }\n  })[0]\n\n  if(req.lobby.isGamePoweredOn) {\n    return res.status(400).json({ message: 'You cannot assign a role when the lobby game is powered on' });\n  }\n\n  if(req.body.role === 'gameHost') {\n    if(req.body.userId === 'unassigned') {\n      req.lobby.gameHostId = null\n    } else {\n      req.lobby.gameHostId = req.body.userId\n    }\n\n  }\n\n  if(req.body.role === 'participant') {\n    if(req.body.userId === 'unassigned') {\n      req.lobby.participantId = null\n    } else {\n      req.lobby.participantId = req.body.userId\n    }\n  }\n\n  if(req.body.role === 'guide') {\n    if(req.body.userId === 'unassigned') {\n      req.lobby.guideId = null\n    } else {\n      const user = await User.findById(req.body.userId)\n      if(user.role == 'ADMIN') {\n        req.lobby.guideId = req.body.userId\n      } else {\n        return res.status(400).json({ message: 'Guide must be admin role' });\n      }\n    }\n  }\n\n  const updatedLobby = await Lobby.findByIdAndUpdate(\n    req.params.id,\n    { \n      gameHostId: req.lobby.gameHostId,\n      participantId: req.lobby.participantId,\n      guideId: req.lobby.guideId,\n    },\n    { new: true },\n  );\n\n  // if(!userFound) {\n  //   return res.status(400).json({ message: 'You are not a member of this lobby' });\n  // }\n\n  req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n  return res.status(200).json({ lobby: req.lobby });\n})\n\nrouter.post('/join/:id', requireJwtAuth, requireLobby, requireSocketAuth, async (req, res) => {\n  try {\n    const userFound = req.lobby.users.filter((u, i) => {\n      if(u.id === req.user.id) {\n        return true\n      } else {\n        return false\n      }\n    })[0]\n    \n    if(userFound) {\n      req.socket.join(req.lobby.id);\n      if(req.user.role === 'ADMIN') req.socket.join('admins@'+req.lobby.id);\n      userFound.joined = true;\n      req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n      return res.status(200).json({ lobby: req.lobby });\n    }\n\n    const isParticipant = req.lobby.participants.some((user) => {\n      return user.id === req.user.id\n    })\n\n    if (!(req.user.role === 'ADMIN' || isParticipant)) {\n      return res.status(400).json({ message: 'You do not have permission to join that lobby.' });\n    }\n\n    // generate a lobby formatted user\n    const newLobbyUser = { \n      email: req.user.email,\n      id: req.user.id,\n      username: req.user.username,\n      role: req.user.role,\n      joined: true,\n      connected: true\n    }\n\n    // listen for all of this lobbies events\n    req.socket.join(req.lobby.id);\n    if(req.user.role === 'ADMIN') req.socket.join('admins@'+req.lobby.id);\n\n    // remove from all other lobbies\n    req.lobbys.forEach((lobby) => {\n      let index;\n      lobby.users.forEach((user, i) => {\n        if(newLobbyUser.id === user.id) {\n          index = i\n        }\n      })\n      if(index >= -1) {\n        lobby.users.splice(index, 1)\n        req.socket.leave(lobby.id);\n        req.io.to(lobby.id).emit(ON_LOBBY_UPDATE, {lobby: lobby});\n      }\n    })\n\n    // add to new lobby\n    req.lobby.users.push(newLobbyUser)\n\n    // update the lobbies with this information\n    req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n    return res.status(200).json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong: ' + err });\n  }\n});\n\nrouter.delete('/:id', requireJwtAuth, requireLobby, async (req, res) => {\n  try {\n    if (req.user.role !== 'ADMIN') {\n      return res.status(400).json({ message: 'You do not have privileges to delete that lobby.' });\n    }\n\n    try {\n      const lobby = await Lobby.findByIdAndRemove(req.params.id).populate('participants');\n      req.lobbys.splice(req.lobbyIndex, 1);\n      if (!lobby) return res.status(404).json({ game: 'No game found.' });\n    } catch (err) {\n      res.status(500).json({ game: 'Something went wrong.' });\n    }\n\n    res.status(200).json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\n\nrouter.put('/user/:id', requireJwtAuth, requireLobby, requireSocketAuth, async (req, res) => {\n  try {\n    if (!(req.body.userId === req.user.id || req.user.role === 'ADMIN')) {\n      return res.status(400).json({ message: 'You do not have privileges to update that user in that lobby.' });\n    }\n\n    let index;\n    const userFound = req.lobby.users.filter((u, i) => {\n      if(u.id === req.body.userId) {\n        index = i\n        return true\n      } else {\n        return false\n      }\n    })[0]\n\n    if(!userFound) {\n      return res.status(400).json({ message: 'No user with id ' + req.body.userId + ' found in lobby' });\n    }\n\n    req.lobby.users[index] = { ...req.lobby.users[index], ...req.body.user}\n    req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n    res.status(200).json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.put('/:id', requireJwtAuth, requireLobby, requireSocketAuth, async (req, res) => {\n  try {\n\n    if(req.lobby.isGamePoweredOn && req.body.gameId) {\n      return res.status(400).json({ message: 'You cannot change the game id of a lobby when game is powered on' });\n    }\n\n    if(req.body.isGamePoweredOn && req.user.role !== 'ADMIN') {\n      return res.status(400).json({ message: 'You do not have privelages to power on this game.' });\n    }\n\n    const updatedLobby = await Lobby.findByIdAndUpdate(\n      req.params.id,\n      { \n        participants: req.body.participants,\n        startTime: req.body.startTime,\n        gameHostId: req.body.gameHostId,\n        participantId: req.body.participantId,\n        guideId: req.body.guideId,\n        game: req.body.game\n      },\n      { new: true },\n    );\n\n    Object.assign(req.lobby,req.body)\n    req.io.to(req.lobby.id).emit(ON_LOBBY_UPDATE, {lobby: req.lobby});\n    res.status(200).json({ lobby: req.lobby });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nexport default router;\n"],"file":"lobbys.js"}