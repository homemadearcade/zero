{"version":3,"sources":["../../../src/routes/api/cobrowsing.js"],"names":["router","post","requireJwtAuth","requireSocketAuth","req","res","user","role","status","json","message","socket","join","params","id","socketSession","app","get","findSession","emit","ON_COBROWSING_SUBSCRIBED","User","findById","cobrowsingUser","err","leave","send","put","io","to","ON_COBROWSING_UPDATE","userId","remoteState","body","ON_COBROWSING_REMOTE_DISPATCH","dispatchData"],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport requireJwtAuth from '../../middleware/requireJwtAuth';\nimport requireSocketAuth from '../../middleware/requireSocketAuth';\n\nimport User from '../../models/User';\n\nimport { ON_COBROWSING_UPDATE, ON_COBROWSING_SUBSCRIBED, ON_COBROWSING_REMOTE_DISPATCH } from '../../constants';\n\nconst router = Router();\n\nrouter.post('/:id', requireJwtAuth, requireSocketAuth, async (req, res) => {\n  try {\n    if(req.user.role !== 'ADMIN') {\n      return res.status(400).json({ message: 'You do not have privileges to register cobrowse.' });\n    }\n\n    req.socket.join('cobrowsing@'+req.params.id);\n\n    const socketSession = req.app.get('socketSessions').findSession(req.params.id)\n    if(socketSession) {\n      socketSession.emit(ON_COBROWSING_SUBSCRIBED);\n    }\n    \n    const user = await User.findById(req.params.id)\n    res.status(200).json({ cobrowsingUser: user });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.post('/stop/:id', requireJwtAuth, requireSocketAuth, async (req, res) => {\n  try {\n    if(req.user.role !== 'ADMIN') {\n      return res.status(400).json({ message: 'You do not have privileges to unregister this cobrowse.' });\n    }\n\n    req.socket.leave('cobrowsing@'+req.params.id);    \n    res.status(200).send()\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.put('/:id', requireJwtAuth, requireSocketAuth, async (req, res) => {\n  try {\n    if (!(req.params.id === req.user.id || req.user.role === 'ADMIN')) {\n      return res.status(400).json({ message: 'You do not have privileges to update this users cobrowse state.' });\n    }\n\n    req.io.to('cobrowsing@'+req.params.id).emit(ON_COBROWSING_UPDATE, {\n      userId: req.params.id,\n      remoteState: req.body.remoteState\n    });\n\n    res.status(200).send();\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nrouter.put('/dispatch/:id', requireJwtAuth, requireSocketAuth, async (req, res) => {\n  try {\n    if (!(req.params.id === req.user.id || req.user.role === 'ADMIN')) {\n      return res.status(400).json({ message: 'You do not have privileges to update this users cobrowse state.' });\n    }\n\n    const socketSession = req.app.get('socketSessions').findSession(req.params.id)\n    socketSession.emit(ON_COBROWSING_REMOTE_DISPATCH, {\n      dispatchData: req.body.dispatchData\n    });\n\n    res.status(200).send();\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong. ' + err });\n  }\n});\n\nexport default router;\n"],"file":"cobrowsing.js"}